<!--
 * @Author: LinFeng
 * @LastEditors: LinFeng
 * @Date: 2020-07-25 22:17:51
 * @LastEditTime: 2020-07-28 11:27:17
 * @FilePath: /react-elm/学习笔记.md
 * @Description:
-->

## 2020.7.25

### router 内重定向到某个地址可以跳转, 但是在浏览器直接刷新却会 404

https://segmentfault.com/q/1010000010844476

之所以你在浏览器内可以由首页跳转到其他路由地址，是因为这是由前端自行渲染的，你在 React Router 定义了对应的路由，脚本并没有刷新网页访问后台，是 JS 动态更改了 location。

当你刷新时，你首先是访问的后台地址，然后返回的页面内加载了 React 代码，最后在浏览器内执行；也就是说如果这个时候报 404，是因为你后台并没有针对这个路由给出返回 HTML 内容，也谈不上执行 React Router 了。

解决办法就一条：如果你期望所有的路由都由 React Router 来定义，只有你的后台，无论任何路径，都返回 index.html 就好了。剩下的事情交给 React Router。那么你要做的就是修改后台服务器，可以放在 apache，也可以放在你的 java 路由内做一个通配路径处理。

解决方案:

1. 开发时, webpack.dev.js:

```javascript
module.exports = merge(webpackCommonConf, {
  mode: "development",
  output: {
    publicPath: "/build/dist/", // 修改所有静态文件 url 的前缀
  },
  devServer: {
    historyApiFallback: {
      index: "/build/dist/index.html",
    },
  },
});
```

2. 上线时, nginx 的配置, 参考

```txt
    server {
    listen 80;
    server_name adminv2.jianliwu.com;
    access_log /etc/nginx/logs/access.log combined;
    index index.html index.jsp index.php;

    location = / {
        root /product/front/admin-v2-fe/dist;
        index index.html;
    }
    location ~ .*\.html$ {
        root /product/front/admin-v2-fe/dist;
        index index.html;
    }
    location ~ .*\.do$ {
        proxy_pass http://admintest.happymmall.com;
    }
    location / {
        try_files $uri $uri/ /index.html;
    }
}
```

用 location 重定向

还没到上线的时候, 感觉可能还有坑. TODO

## 2020.7.28

### 首页的滚动处理

#### 首页的走马灯横向滚动, chrome 报错

错误为: [Intervention] Unable to preventDefault inside passive event listener due to target being treated as passive. See <URL>

[关于 passive event listener 的一次踩坑](https://juejin.im/post/5ad804c1f265da504547fe68)

[滑动时候警告：Unable to preventDefault inside passive event listener](https://www.jianshu.com/p/04bf173826aa)

解决方法:

由于走马灯是从 antd-mobile 引入的组件无法修改源码, 所以用 css 方法, 在走马灯组件上加上 css 样式: [touch-action](https://developer.mozilla.org/zh-CN/docs/Web/CSS/touch-action)

```css
.wrapper {
  touch-action: pan-y; // 允许的滑动
}
```

#### 首页的纵向滚动处理:

使用库: [better-scroll](https://better-scroll.github.io/docs/zh-CN/guide/#betterscroll-%E6%98%AF%E4%BB%80%E4%B9%88)

注意查看[使用 better-scroll 的常见问题](https://better-scroll.github.io/docs/zh-CN/FAQ/diagnosis.html), 其中 click 事件暂时没用到, 可能需要回头填坑

使用方法:

```javascript
import BScroll from "better-scroll";
let wrapper = document.querySelector(".wrapper"); // 要求.wrapper 定高
let scroll = new BScroll(wrapper);

// 如果wrapper里面的内容高度会改变 需要调用
scroll.refresh();
```

### 菜单滚动定位问题, popup 随着页面滚动, 滚动穿透

[Select Dropdown DatePicker TimePicker Popover Popconfirm 会跟随滚动条上下移动？](https://ant.design/docs/react/faq-cn#Select-Dropdown-DatePicker-TimePicker-Popover-Popconfirm-%E4%BC%9A%E8%B7%9F%E9%9A%8F%E6%BB%9A%E5%8A%A8%E6%9D%A1%E4%B8%8A%E4%B8%8B%E7%A7%BB%E5%8A%A8%EF%BC%9F)

[解决移动端滚动穿透](https://juejin.im/post/5c4974f0518825260c5d1851)

[滚动穿透问题探索](https://juejin.im/post/5c49bc74e51d4504314306e6)

在 src/page/food-category/components/options-cascader 中出现该问题, 解决方法如第一个链接, 为 popup 设置目标容器

```javascript
<div
    style={{
    position: "fixed",
    zIndex: 100,
    top: "90px",
    bottom: 0,
    background: "rgba(0, 0, 0, 0)",
    width: "100%",
    }}
    id="popuparea"
/>
<div className="options-cascader-wrapper">
<Cascader getPopupContainer={() => document.getElementById("popuparea")} />
```
